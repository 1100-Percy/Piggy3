{% extends 'base.html' %}

{% block content %}
<div id="start-container" class="d-flex flex-column align-items-center justify-content-center min-vh-100 text-center position-relative" style="overflow: hidden;">
    <div class="piggy-face bg-white shadow mb-4 d-flex align-items-center justify-content-center border border-2 border-warning rounded" style="width: 120px; height: 120px;">
        <img src="/static/image/lulu2.gif" class="custom-piggy-img" alt="Piggy Chef">
    </div>
    
    <h2 class="mb-5" style="color: #5D4037;">How many dishes today?</h2>

    <!-- Slider -->
    <div class="w-100 px-5 mb-5" style="max-width: 500px;">
        <label for="taskRange" class="form-label fw-bold mb-3" id="task-label">3 Tasks (Balanced Meal)</label>
        <input type="range" class="form-range custom-range" min="1" max="5" step="0.01" id="taskRange" value="3" style="height: 30px;">
        <div class="d-flex justify-content-between text-muted small mt-2">
            <span>Snack (1)</span>
            <span>Feast (5)</span>
        </div>
    </div>

    <button id="cook-btn" class="btn btn-primary btn-lg px-5 py-3 shadow-lg rounded-pill">
        Start Cooking
    </button>
</div>

<script>
    const range = document.getElementById('taskRange');
    const label = document.getElementById('task-label');
    const btn = document.getElementById('cook-btn');
    const container = document.getElementById('start-container');

    // Init: Check thinking type to set background
    async function initBackground() {
        try {
            const res = await fetch('/api/check_auth/');
            const data = await res.json();
            
            if (data.is_authenticated && data.thinking_type) {
                if (data.thinking_type === 'convergent') {
                    container.classList.add('start-bg-red');
                } else {
                    container.classList.add('start-bg-clear');
                }
            } else {
                // Default fallback
                container.classList.add('start-bg-clear');
            }
        } catch (err) {
            console.error('Failed to load user preference', err);
            container.classList.add('start-bg-clear');
        }
    }
    
    initBackground();

    const labels = {
        1: "1 Task (Light Snack)",
        2: "2 Tasks (Appetizer)",
        3: "3 Tasks (Balanced Meal)",
        4: "4 Tasks (Hearty Dinner)",
        5: "5 Tasks (Full Banquet)"
    };

    range.addEventListener('input', () => {
        // Smooth transition for label update
        const val = Math.round(range.value);
        
        // Only update label if the integer value changes to avoid flickering
        if (label.dataset.lastVal != val) {
            label.style.opacity = '0.5';
            setTimeout(() => {
                label.textContent = labels[val];
                label.style.opacity = '1';
            }, 100);
            label.dataset.lastVal = val;
        }
        
        // Piggy nod logic could go here
    });

    btn.addEventListener('click', async () => {
        const count = Math.round(range.value); // Ensure integer
        
        // Animation
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Chopping...';
        btn.disabled = true;

        try {
            const res = await fetch('/api/generate_tasks/', {
                method: 'POST',
                body: JSON.stringify({count: count}),
                headers: {'Content-Type': 'application/json'}
            });
            const result = await res.json();
            
            if (result.status === 'success') {
                // Store graph_id/task_ids in sessionStorage if needed, or backend handles context
                setTimeout(() => {
                    window.location.href = '/key_info/';
                }, 1000);
            } else {
                alert("Error: " + result.message);
                btn.innerHTML = 'Start Cooking';
                btn.disabled = false;
            }
        } catch (err) {
            console.error(err);
            alert("Network Error");
            btn.innerHTML = 'Start Cooking';
            btn.disabled = false;
        }
    });
</script>
{% endblock %}
