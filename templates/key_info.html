{% extends 'base.html' %}

{% block content %}
<div class="d-flex flex-column h-100 min-vh-100">
    <!-- Graph Section (60%) -->
    <div class="flex-grow-1 position-relative" style="height: 60vh; background: #DEB887; overflow: hidden;">
        <div id="mynetwork" class="w-100 h-100"></div>
        <!-- Piggy Hint -->
        <div class="position-absolute top-0 start-0 m-3 p-2 bg-white rounded shadow text-small" style="max-width: 200px;">
            <span class="fs-4">üê∑</span> Click nodes to explore!
        </div>
    </div>

    <!-- Tasks Section (40%) -->
    <div class="bg-white p-4 rounded-top-4 shadow-lg position-relative" style="height: 40vh; margin-top: -20px; z-index: 10;">
        <h4 class="fw-bold mb-3" style="color: #5D4037;">Today's Menu</h4>
        <div id="task-list" class="overflow-auto" style="height: calc(100% - 50px);">
            <!-- Tasks injected here -->
            <div class="text-center mt-5 text-muted">
                <div class="spinner-border text-warning" role="status"></div>
                <p>Loading Ingredients...</p>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Fetch Data
        try {
            const res = await fetch('/api/get_dashboard_data/');
            const data = await res.json();
            
            if (data.status === 'success') {
                renderGraph(data.graph);
                renderTasks(data.tasks);
            } else {
                alert("Failed to load data: " + data.message);
                window.location.href = '/login/';
            }
        } catch (err) {
            console.error(err);
            // Offline Fallback logic would go here
        }
    });

    function renderGraph(graphData) {
        const container = document.getElementById('mynetwork');
        // Convert mock data to vis format
        // Mock data structure: {nodes: [{id: 1, label: 'X', ...}], edges: [{from: 1, to: 2}]}
        
        const nodes = new vis.DataSet(graphData.nodes);
        const edges = new vis.DataSet(graphData.edges);
        
        const data = { nodes, edges };
        const options = {
            nodes: {
                shape: 'dot',
                size: 20,
                font: { size: 16 }
            },
            edges: {
                color: '#8D6E63',
                width: 2
            },
            physics: {
                enabled: true
            }
        };
        
        const network = new vis.Network(container, data, options);
        
        network.on("click", function (params) {
            if (params.nodes.length > 0) {
                // Highlight logic (Visual only for now)
                console.log("Clicked node:", params.nodes[0]);
            }
        });
    }

    function renderTasks(tasks) {
        const list = document.getElementById('task-list');
        list.innerHTML = '';
        
        if (tasks.length === 0) {
            list.innerHTML = '<p class="text-center text-muted">All dishes cooked! Good job!</p>';
            return;
        }

        tasks.forEach(task => {
            const isDone = task.is_completed;
            const card = document.createElement('div');
            card.className = `card mb-3 border-0 shadow-sm ${isDone ? 'bg-light text-muted' : 'bg-white'}`;
            card.innerHTML = `
                <div class="card-body d-flex justify-content-between align-items-center p-3" onclick="${!isDone ? `location.href='/task_detail/?id=${task.id}'` : ''}" style="cursor: pointer;">
                    <div class="d-flex align-items-center">
                        <span class="fs-4 me-3">${isDone ? '‚úÖ' : 'üî™'}</span>
                        <h6 class="mb-0 ${isDone ? 'text-decoration-line-through' : 'fw-bold'}">${task.content}</h6>
                    </div>
                    ${!isDone ? '<span class="text-primary">></span>' : ''}
                </div>
            `;
            list.appendChild(card);
        });
    }
</script>
{% endblock %}
